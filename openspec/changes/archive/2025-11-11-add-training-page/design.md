## Context
需要建立一個可擴充的模型訓練系統，支援多種訓練演算法和損失函式。系統必須簡單易用，適合非程式人員，同時保持足夠的彈性以便未來擴展新的模型類型。

## Goals / Non-Goals
- **Goals**:
  - 建立模型抽象框架，定義統一的模型介面
  - 實作線性回歸和線性回歸梯度下降兩種訓練方式
  - 支援單一或多個目標變數的訓練
  - 提供簡單直觀的損失函式選擇介面
  - 實作模型保存和載入機制
  - 顯示訓練結果和評估指標

- **Non-Goals**:
  - 預測頁面的實作（後續提案）
  - 進階的超參數調整功能
  - 模型比較和選擇功能（未來可擴展）

## Decisions

### 模型抽象框架設計
- **決策**：建立一個抽象基類 `BaseModel`，所有模型都繼承此類別
- **理由**：確保所有模型實作統一的介面（fit, predict, save, load），方便替換和擴展
- **實作**：
  ```python
  class BaseModel:
      def fit(self, X, y, **kwargs): pass
      def predict(self, X): pass
      def save(self, path): pass
      def load(self, path): pass
      def get_info(self): pass  # 返回模型資訊
  ```

### 目標變數選擇
- **決策**：支援單一目標變數（迴歸）和多個目標變數（多輸出迴歸）
- **理由**：使用者需求明確提到可以選擇單一或多個目標變數
- **實作**：
  - 使用多選下拉選單讓使用者選擇目標變數
  - 單一目標變數：標準迴歸問題
  - 多個目標變數：使用 MultiOutputRegressor 包裝器

### 損失函式選擇
- **決策**：提供預設的損失函式選項（MSE, MAE），並允許進階使用者自訂
- **理由**：簡化介面，避免非程式人員困惑，同時保持彈性
- **實作**：
  - 使用簡單的下拉選單選擇預設損失函式
  - 對於梯度下降，損失函式影響訓練過程
  - 對於標準線性回歸，損失函式主要用於評估

### 模型實作策略
- **線性回歸（Scikit-learn）**：
  - 使用 `sklearn.linear_model.LinearRegression`
  - 支援單一和多個目標變數
  - 快速且穩定
  - 使用最小二乘法（OLS）求解

- **線性回歸梯度下降（Scikit-learn SGDRegressor）**：
  - 使用 `sklearn.linear_model.SGDRegressor`
  - 支援不同的損失函式（squared_loss/MSE, huber, epsilon_insensitive/MAE）
  - 支援單一目標變數（多目標需使用 MultiOutputRegressor）
  - 可以透過 `partial_fit` 方法逐步訓練並記錄損失變化
  - 穩定且經過優化的實作，比自訂實作更可靠

### 資料來源
- **決策**：訓練頁面可以從資料分析頁面的 session state 取得資料，或允許上傳新資料
- **理由**：提供彈性，使用者可以分析資料後直接訓練，或使用新資料
- **實作**：
  - 優先檢查 session state 中是否有資料分析頁面的資料
  - 如果沒有，提供檔案上傳功能

### 模型保存格式
- **決策**：使用 Joblib 保存模型（比 Pickle 更適合 Scikit-learn 模型）
- **理由**：Joblib 對 NumPy 陣列處理更有效率，且是 Scikit-learn 推薦的方式
- **實作**：
  - 保存模型物件、訓練參數、目標變數名稱、特徵名稱等元資料
  - 檔案格式：`.joblib`

### 訓練結果顯示
- **決策**：顯示損失曲線（僅梯度下降）、模型參數、評估指標（R², MSE, MAE）
- **理由**：幫助使用者了解模型訓練狀況和效能
- **實作**：
  - 使用 Plotly 繪製損失曲線（如果適用）
  - 顯示模型係數和截距
  - 顯示評估指標表格

## Risks / Trade-offs

### 模型抽象層的複雜度
- **風險**：抽象層可能增加初始開發複雜度
- **緩解**：保持抽象層簡單，只定義必要的方法
- **權衡**：初期複雜度換取長期可擴充性

### 多目標變數的實作
- **風險**：多輸出迴歸可能增加介面複雜度
- **緩解**：使用清晰的 UI 說明，自動處理 MultiOutputRegressor
- **權衡**：功能完整性 vs 介面簡潔性

### 梯度下降實作的穩定性
- **風險**：已解決 - 使用 Scikit-learn 的 SGDRegressor，穩定且經過優化
- **緩解**：使用現成的套件，減少自訂實作的風險
- **權衡**：使用現成套件確保穩定性和可靠性

### 模型相容性
- **風險**：不同模型保存格式可能不相容
- **緩解**：統一使用 BaseModel 介面，確保所有模型實作相同的方法
- **權衡**：統一性 vs 模型特定優化

## Migration Plan
這是新功能實作，無需遷移。但需要確保：
- 訓練頁面可以存取資料分析頁面的資料（透過 session state）
- 模型保存格式與未來預測頁面相容

## Open Questions
- 梯度下降的學習率和迭代次數預設值？
  - **決策**：學習率 0.01，最大迭代 1000 次，收斂容忍度 1e-6

- 是否支援資料分割（訓練/測試）？
  - **決策**：初期不支援，未來可擴展

- 模型版本管理？
  - **決策**：使用時間戳記命名模型檔案，未來可擴展版本管理

